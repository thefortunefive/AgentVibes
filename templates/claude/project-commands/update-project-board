#!/bin/bash
# Update entire project board status for {{emoji}} {{name}}

echo "ğŸ“Š {{emoji}} {{name}} updating project board status..."

# Check if gh is available
if ! command -v gh &> /dev/null; then
    echo "âŒ GitHub CLI (gh) is required but not installed"
    exit 1
fi

# Check if jq is available
if ! command -v jq &> /dev/null; then
    echo "âŒ jq is required but not installed"
    echo "Install with: sudo apt install jq (Ubuntu/Debian) or brew install jq (macOS)"
    exit 1
fi

echo "ğŸ”„ Syncing project board state..."

# Get all project items
echo "Fetching project items..."
items=$(gh project item-list {{projectId}} --owner {{owner}} --limit 1000 --format json)

# Count items by status
echo "ğŸ“ˆ Project Board Summary:"
echo "========================"

total_items=$(echo "$items" | jq '.items | length')
echo "Total Items: $total_items"

# Count by status (you may need to adjust field names)
todo_count=$(echo "$items" | jq '[.items[] | select(.status == "ğŸ“‹ Todo")] | length')
in_progress_count=$(echo "$items" | jq '[.items[] | select(.status == "ğŸš€ In Progress")] | length')
paused_count=$(echo "$items" | jq '[.items[] | select(.status == "â¸ï¸ Paused")] | length')
review_count=$(echo "$items" | jq '[.items[] | select(.status == "ğŸ‘€ Ready for Review")] | length')
testing_count=$(echo "$items" | jq '[.items[] | select(.status == "ğŸ§ª Testing PR")] | length')
rework_count=$(echo "$items" | jq '[.items[] | select(.status == "ğŸ”„ Rework")] | length')
merge_count=$(echo "$items" | jq '[.items[] | select(.status == "âœ… Merge PR")] | length')
done_count=$(echo "$items" | jq '[.items[] | select(.status == "âœ¨ Done")] | length')

echo "ğŸ“‹ Todo: $todo_count"
echo "ğŸš€ In Progress: $in_progress_count"
echo "â¸ï¸ Paused: $paused_count"
echo "ğŸ‘€ Ready for Review: $review_count"
echo "ğŸ§ª Testing PR: $testing_count"
echo "ğŸ”„ Rework: $rework_count"
echo "âœ… Merge PR: $merge_count"
echo "âœ¨ Done: $done_count"

echo ""
echo "ğŸ” Items assigned to {{emoji}} {{name}}:"
echo "========================================"

# Show items assigned to this agent (by looking for agent emoji in title)
assigned_items=$(echo "$items" | jq -r '.items[] | select(.content.title | contains("{{emoji}}")) | "\(.content.number): \(.content.title) [\(.status // "No Status")]"')

if [ -z "$assigned_items" ]; then
    echo "No items currently assigned to {{emoji}} {{name}}"
else
    echo "$assigned_items"
fi

echo ""
echo "ğŸ¯ Recommendations for {{emoji}} {{name}}:"
echo "========================================="

if [ "$in_progress_count" -eq 0 ] && [ "$todo_count" -gt 0 ]; then
    echo "ğŸ’¡ Consider starting work on a Todo item using: /start-issue <number>"
elif [ "$in_progress_count" -gt 2 ]; then
    echo "âš ï¸ Many items in progress - consider focusing on completing current work"
fi

if [ "$review_count" -gt 3 ]; then
    echo "ğŸ‘€ Many items awaiting review - consider reviewing PRs"
fi

if [ "$paused_count" -gt 0 ]; then
    echo "â¸ï¸ Paused items detected - consider resuming with: /resume-issue <number>"
fi

echo ""
echo "ğŸ”— Full board: https://github.com/{{owner}}/{{repo}}/projects"
echo ""
echo "{{emoji}} {{name}} says: \"{{#each personality.catchphrases}}{{#if @first}}{{this}}{{/if}}{{/each}}\""