#!/bin/bash
# Link PR to issue for {{emoji}} {{name}}

if [ -z "$1" ] || [ -z "$2" ]; then
    echo "Usage: link-pr <issue_number> <pr_number>"
    echo "Example: link-pr 42 123"
    exit 1
fi

issue_num="$1"
pr_num="$2"

echo "üîó {{emoji}} {{name}} linking PR #$pr_num to issue #$issue_num..."

# Check if gh is available
if ! command -v gh &> /dev/null; then
    echo "‚ùå GitHub CLI (gh) is required but not installed"
    exit 1
fi

# Add comment to issue linking the PR
gh issue comment $issue_num --body "{{emoji}} {{name}} says: Created PR #$pr_num for this issue!

**PR Link**: https://github.com/{{owner}}/{{repo}}/pull/$pr_num

This PR will close this issue when merged. {{#each personality.catchphrases}}{{#if @first}}{{this}}{{/if}}{{/each}}"

# Add comment to PR referencing the issue
gh pr comment $pr_num --body "{{emoji}} {{name}} says: This PR addresses issue #$issue_num

**Issue Link**: https://github.com/{{owner}}/{{repo}}/issues/$issue_num

Closes #$issue_num"

# Update project board to move PR to Ready for Review
if command -v jq &> /dev/null; then
    echo "üìä Updating project board..."
    item_id=$(gh project item-list {{projectId}} --owner {{owner}} --limit 1000 --format json | jq -r ".items[] | select(.content.number == $pr_num) | .id")
    
    if [ ! -z "$item_id" ]; then
        # Move to Ready for Review
        gh project item-edit --project-id {{projectId}} --id $item_id --field-id {{statusFieldId}} --single-select-option-id READY_FOR_REVIEW_ID
        echo "‚úÖ Moved PR #$pr_num to Ready for Review"
    else
        echo "‚ö†Ô∏è Could not find PR #$pr_num in project board"
    fi
fi

echo ""
echo "‚úÖ {{emoji}} {{name}} successfully linked PR #$pr_num to issue #$issue_num"
echo "üîó View PR: https://github.com/{{owner}}/{{repo}}/pull/$pr_num"
echo "üîó View Issue: https://github.com/{{owner}}/{{repo}}/issues/$issue_num"
echo ""
echo "{{emoji}} {{name}} says: \"{{#each personality.catchphrases}}{{#if @first}}{{this}}{{/if}}{{/each}}\""