#!/bin/bash
# Build script for {{emoji}} {{name}} - {{theme}} Agent

echo "ðŸ—ï¸ Building {{emoji}} {{name}}..."

# Set build environment
export NODE_ENV=production
export AGENT_NAME="{{name}}"
export AGENT_EMOJI="{{emoji}}"

# Clean previous builds
if [ -d "dist" ]; then
    echo "ðŸ§¹ Cleaning previous build..."
    rm -rf dist
fi

if [ -d ".next" ]; then
    echo "ðŸ§¹ Cleaning Next.js cache..."
    rm -rf .next
fi

# Install dependencies
if [ -f "package.json" ]; then
    echo "ðŸ“¦ Installing dependencies..."
    npm ci
    
    # Run build script
    if npm run build; then
        echo "âœ… Build completed successfully"
    else
        echo "âŒ Build failed"
        exit 1
    fi
    
    # Run tests if available
    if npm run test --if-present; then
        echo "âœ… Tests passed"
    else
        echo "âš ï¸ Tests failed or not available"
    fi
    
elif [ -f "requirements.txt" ]; then
    # Python project
    echo "ðŸ Installing Python dependencies..."
    pip install -r requirements.txt
    
    # Run Python tests if available
    if [ -f "test_*.py" ] || [ -d "tests/" ]; then
        echo "ðŸ§ª Running Python tests..."
        python -m pytest
    fi
    
elif [ -f "go.mod" ]; then
    # Go project
    echo "ðŸš€ Building Go application..."
    go mod tidy
    go build -o main .
    
    # Run Go tests if available
    echo "ðŸ§ª Running Go tests..."
    go test ./...
    
else
    echo "âš ï¸ No recognized project type found"
    echo "ðŸ“ Supported: package.json (Node.js), requirements.txt (Python), go.mod (Go)"
fi

# Create build info
echo "{{emoji}} {{name}} - {{theme}} Agent" > build-info.txt
echo "Built on: $(date)" >> build-info.txt
echo "Agent: {{name}}" >> build-info.txt
echo "Theme: {{theme}}" >> build-info.txt
echo "Team: {{teamNumber}}" >> build-info.txt
echo "Ports: {{ports.backend}} (backend), {{ports.frontend}} (frontend)" >> build-info.txt

echo ""
echo "âœ… {{emoji}} {{name}} build complete!"
echo "ðŸš€ Ready to launch with: ./launch"
echo ""
echo "{{emoji}} {{name}} says: \"{{#each personality.catchphrases}}{{#if @first}}{{this}}{{/if}}{{/each}}\""