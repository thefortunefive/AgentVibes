#!/bin/bash
# Shutdown script for {{emoji}} {{name}} - {{theme}} Agent

echo "üõë Stopping {{emoji}} {{name}}..."

# Kill process by PID if available
if [ -f .pid ]; then
    PID=$(cat .pid)
    if kill -0 $PID 2>/dev/null; then
        echo "üîÑ Stopping process $PID..."
        kill $PID
        
        # Wait for graceful shutdown
        sleep 3
        
        # Force kill if still running
        if kill -0 $PID 2>/dev/null; then
            echo "‚ö° Force stopping process $PID..."
            kill -9 $PID
        fi
    fi
    rm .pid
fi

# Stop any processes on our ports
if lsof -ti:{{ports.backend}} > /dev/null 2>&1; then
    echo "üîÑ Stopping services on port {{ports.backend}}..."
    lsof -ti:{{ports.backend}} | xargs kill 2>/dev/null
fi

if lsof -ti:{{ports.frontend}} > /dev/null 2>&1; then
    echo "üîÑ Stopping services on port {{ports.frontend}}..."
    lsof -ti:{{ports.frontend}} | xargs kill 2>/dev/null
fi

# Clean up any node processes related to this agent
pkill -f "{{ports.backend}}" 2>/dev/null || true
pkill -f "{{ports.frontend}}" 2>/dev/null || true

# Wait a moment
sleep 2

# Verify shutdown
if lsof -i :{{ports.backend}} > /dev/null 2>&1; then
    echo "‚ö†Ô∏è Port {{ports.backend}} may still be in use"
else
    echo "‚úÖ Port {{ports.backend}} is now free"
fi

if lsof -i :{{ports.frontend}} > /dev/null 2>&1; then
    echo "‚ö†Ô∏è Port {{ports.frontend}} may still be in use"
else
    echo "‚úÖ Port {{ports.frontend}} is now free"
fi

echo "‚úÖ {{emoji}} {{name}} stopped successfully"
echo "{{emoji}} {{name}} says: \"{{#each personality.catchphrases}}{{#if @first}}{{this}}{{/if}}{{/each}}\""