#!/bin/bash
# Launch script for {{emoji}} {{name}} - {{theme}} Agent

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

clear

echo "================================================================================"
echo "AGENTVIBES {{theme}} AGENT v1.0"
echo "================================================================================"
echo ""
echo "ğŸ”¥ Starting independent environment for: {{name}} ({{emoji}})"
echo "ğŸ“ Working directory: $(pwd)"
echo ""
echo "CONFIGURATION LOADED:"
echo "â”œâ”€ ğŸŒ Host: {{host}}"
echo "â”œâ”€ ğŸ”— Backend: {{ports.backend}}"
echo "â”œâ”€ ğŸ–¥ï¸  Frontend: {{ports.frontend}}"
{{#if ports.nginx}}
echo "â”œâ”€ ğŸŒ Nginx: {{ports.nginx}}"
{{/if}}
echo "â””â”€ ğŸ­ Theme: {{theme}}"
echo ""

# Check port availability
echo "PORT AVAILABILITY:"
PORT_CONFLICTS=false

if lsof -i :{{ports.backend}} > /dev/null 2>&1; then
    echo "âŒ Port {{ports.backend}} (backend) is in use"
    PORT_CONFLICTS=true
    lsof -ti:{{ports.backend}} | xargs kill 2>/dev/null || true
    echo "   ğŸ”„ Cleared conflicting process"
fi

if lsof -i :{{ports.frontend}} > /dev/null 2>&1; then
    echo "âŒ Port {{ports.frontend}} (frontend) is in use"
    PORT_CONFLICTS=true
    lsof -ti:{{ports.frontend}} | xargs kill 2>/dev/null || true
    echo "   ğŸ”„ Cleared conflicting process"
fi

{{#if ports.nginx}}
if lsof -i :{{ports.nginx}} > /dev/null 2>&1; then
    echo "âŒ Port {{ports.nginx}} (nginx) is in use"
    PORT_CONFLICTS=true
    lsof -ti:{{ports.nginx}} | xargs kill 2>/dev/null || true
    echo "   ğŸ”„ Cleared conflicting process"
fi
{{/if}}

if [ "$PORT_CONFLICTS" = true ]; then
    echo "   ğŸ’¤ Waiting for ports to clear..."
    sleep 3
fi

echo "âœ… All required ports are now available"
echo "   â€¢ {{ports.backend}} (backend)"
echo "   â€¢ {{ports.frontend}} (frontend)"
{{#if ports.nginx}}
echo "   â€¢ {{ports.nginx}} (nginx)"
{{/if}}
echo ""

# First time setup
if [ ! -f ".initialized" ]; then
    echo "ğŸ”§ FIRST TIME SETUP:"
    
    if [ -f "package.json" ]; then
        echo "â”œâ”€ ğŸ“¦ Installing dependencies..."
        npm install > /dev/null 2>&1
        echo "â”œâ”€ âœ… Dependencies installed"
    fi
    
    if [ -f "package.json" ] && npm run build --if-present > /dev/null 2>&1; then
        echo "â”œâ”€ ğŸ—ï¸  Build completed"
    fi
    
    touch .initialized
    echo "â””â”€ âœ… {{name}} initialized successfully"
    echo ""
fi

# Set environment variables
export NODE_ENV=development
export AGENT_NAME="{{name}}"
export AGENT_EMOJI="{{emoji}}"
export BACKEND_PORT={{ports.backend}}
export FRONTEND_PORT={{ports.frontend}}
export TEAM_NUMBER={{teamNumber}}
export THEME="{{theme}}"
export HOST="{{host}}"

echo "ğŸš€ STARTING SERVICES..."

# Start the application
if [ -f "package.json" ]; then
    echo "â”œâ”€ ğŸ“¦ Node.js application detected"
    if npm run dev > /dev/null 2>&1; then
        echo "â”œâ”€ ğŸ”„ Starting with npm run dev..."
        npm run dev > .agent.log 2>&1 &
    elif npm start > /dev/null 2>&1; then
        echo "â”œâ”€ ğŸ”„ Starting with npm start..."
        npm start > .agent.log 2>&1 &
    else
        echo "â”œâ”€ ğŸ”„ Starting with node..."
        node index.js > .agent.log 2>&1 &
    fi
elif [ -f "main.py" ]; then
    echo "â”œâ”€ ğŸ Python application detected"
    echo "â”œâ”€ ğŸ”„ Starting Python service..."
    python main.py > .agent.log 2>&1 &
elif [ -f "main.go" ]; then
    echo "â”œâ”€ ğŸš€ Go application detected" 
    echo "â”œâ”€ ğŸ”„ Starting Go service..."
    go run main.go > .agent.log 2>&1 &
else
    echo "â”œâ”€ âš ï¸  No recognized application entry point"
    echo "â””â”€ ğŸ“ Please create package.json, main.py, or main.go"
    exit 1
fi

# Store process ID
echo $! > .pid
echo "â”œâ”€ ğŸ“‹ Process ID: $(cat .pid)"

# Wait for startup
echo "â”œâ”€ â³ Waiting for services to start..."
sleep 5

# Health checks
BACKEND_HEALTHY=false
FRONTEND_HEALTHY=false

if curl -s http://localhost:{{ports.backend}}/health > /dev/null 2>&1 || curl -s http://localhost:{{ports.backend}} > /dev/null 2>&1; then
    echo "â”œâ”€ âœ… Backend service is healthy"
    BACKEND_HEALTHY=true
else
    echo "â”œâ”€ âš ï¸  Backend service starting (may take a moment)"
fi

if curl -s http://localhost:{{ports.frontend}} > /dev/null 2>&1; then
    echo "â”œâ”€ âœ… Frontend service is healthy"
    FRONTEND_HEALTHY=true
else
    echo "â”œâ”€ âš ï¸  Frontend service starting (may take a moment)"
fi

echo "â””â”€ ğŸ‰ Launch sequence completed"
echo ""

echo "================================================================================"
if [ "$BACKEND_HEALTHY" = true ] && [ "$FRONTEND_HEALTHY" = true ]; then
    echo "ğŸš€ STARTUP SUCCESSFUL"
else
    echo "ğŸ”„ STARTUP IN PROGRESS"
fi
echo "================================================================================"
echo ""

echo "ACCESS POINTS:"
echo "â”œâ”€ Frontend: http://{{host}}:{{ports.frontend}}"
echo "â”œâ”€ Backend:  http://{{host}}:{{ports.backend}}"
{{#if ports.nginx}}
echo "â”œâ”€ Nginx:    http://{{host}}:{{ports.nginx}}"
{{/if}}
echo "â””â”€ API Docs: http://{{host}}:{{ports.backend}}/docs"
echo ""

echo "NETWORK INFO:"
{{#if dockerNetwork}}
echo "â””â”€ ğŸ”’ Isolated network: {{dockerNetwork}}"
{{else}}
echo "â””â”€ ğŸŒ Local development mode"
{{/if}}
echo ""

echo "USEFUL COMMANDS:"
echo "â”œâ”€ ğŸ“Š View logs:  tail -f .agent.log"
echo "â”œâ”€ ğŸ” Check status: curl http://localhost:{{ports.backend}}/health"
echo "â””â”€ ğŸ›‘ Stop:       ./down"
echo ""

echo "âš ï¸  HOSTS FILE UPDATE REQUIRED:"
echo "Add the following entries to /etc/hosts (or C:\\Windows\\System32\\drivers\\etc\\hosts on Windows):"
echo ""
echo -e "\\$\{CYAN}127.0.0.1   {{host}}\\$\{NC}"
echo ""

echo "ğŸ’¬ {{emoji}} {{name}} says: \"{{#each personality.catchphrases}}{{#if @first}}{{this}}{{/if}}{{/each}}\""
echo ""
echo "ğŸ’¡ Powered by AgentVibes - https://github.com/paulpreibisch/AgentVibes"
echo "ğŸ¦ Follow: @997Fire"
echo ""
echo "================================================================================"