# Dockerfile for {{name}} - {{theme}} Agent
FROM node:18-alpine

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apk add --no-cache \
    git \
    curl \
    bash \
    jq

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci --only=production && \
    npm cache clean --force

# Copy application files
COPY . .

# Create necessary directories
RUN mkdir -p data logs src config

# Build application if build script exists
RUN if [ -f "package.json" ] && npm run build --if-present; then echo "Build completed"; fi

# Set up health check endpoint
RUN echo '#!/bin/bash\necho "{{emoji}} {{name}} is healthy"\nexit 0' > /app/health.sh && \
    chmod +x /app/health.sh

# Expose ports
EXPOSE {{ports.backend}}
EXPOSE {{ports.frontend}}

# Set environment variables
ENV NODE_ENV=production
ENV AGENT_NAME="{{name}}"
ENV AGENT_EMOJI="{{emoji}}"
ENV BACKEND_PORT={{ports.backend}}
ENV FRONTEND_PORT={{ports.frontend}}
ENV THEME="{{theme}}"
ENV TEAM_NUMBER={{teamNumber}}

# Create non-root user
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nextjs -u 1001

# Change ownership of app directory
RUN chown -R nextjs:nodejs /app
USER nextjs

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:${BACKEND_PORT}/health || exit 1

# Start command
CMD ["sh", "-c", "if [ -f 'launch' ]; then ./launch; else npm start; fi"]