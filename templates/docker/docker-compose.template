version: '3.8'

services:
{{#each agents}}
  {{id}}:
    build:
      context: ../agents/{{id}}
      dockerfile: Dockerfile
    container_name: {{../theme}}-{{id}}
    ports:
      - "{{ports.backend}}:{{ports.backend}}"
      - "{{ports.frontend}}:{{ports.frontend}}"
    environment:
      - NODE_ENV=development
      - AGENT_NAME={{name}}
      - AGENT_EMOJI={{emoji}}
      - BACKEND_PORT={{ports.backend}}
      - FRONTEND_PORT={{ports.frontend}}
      - TEAM_NUMBER={{../teamNumber}}
      - THEME={{../theme}}
    networks:
      - {{../dockerNetwork}}
    volumes:
      - {{id}}_data:/app/data
      - {{id}}_logs:/app/logs
      - ./{{id}}:/app/src
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{ports.backend}}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
{{/each}}

networks:
  {{dockerNetwork}}:
    driver: bridge
    name: {{dockerNetwork}}

volumes:
{{#each agents}}
  {{id}}_data:
    name: {{../theme}}_{{id}}_data
  {{id}}_logs:
    name: {{../theme}}_{{id}}_logs
{{/each}}