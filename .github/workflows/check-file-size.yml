name: Check File Sizes

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  check-file-sizes:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Check for large files in tracked files
      run: |
        echo "ðŸ” Checking for files larger than 10MB..."

        # Check git-tracked files (using find for cross-platform compatibility)
        LARGE_FILES=$(git ls-files | while read file; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null)
            if [ "$size" -gt 10485760 ]; then
              echo "$size $file"
            fi
          fi
        done)

        if [ -n "$LARGE_FILES" ]; then
          echo "âŒ ERROR: Found files larger than 10MB in repository:"
          echo "$LARGE_FILES" | while read size file; do
            size_mb=$(awk "BEGIN {printf \"%.2f\", $size / 1048576}")
            echo "  - $file: ${size_mb}MB"
          done
          echo ""
          echo "Large files should not be committed to git."
          echo "Consider using:"
          echo "  - Git LFS for binary assets"
          echo "  - External storage (S3, CDN) with download scripts"
          echo "  - .gitignore to exclude them"
          exit 1
        else
          echo "âœ… No files larger than 10MB found"
        fi

    - name: Check npm package size
      run: |
        echo "ðŸ“¦ Checking npm package size..."

        # Install dependencies to ensure package.json is valid
        npm ci --ignore-scripts

        # Dry-run npm pack to see what would be packaged
        npm pack --dry-run > /tmp/pack-output.txt 2>&1 || true

        # Extract package size
        PACKAGE_SIZE=$(grep "package size:" /tmp/pack-output.txt | awk '{print $3}')
        PACKAGE_UNIT=$(grep "package size:" /tmp/pack-output.txt | awk '{print $4}')

        echo "Package size: $PACKAGE_SIZE $PACKAGE_UNIT"

        # Check if package is larger than 50MB
        if [ "$PACKAGE_UNIT" = "MB" ]; then
          PACKAGE_SIZE_NUM=$(echo "$PACKAGE_SIZE" | tr -d 'MB')
          # Use awk for comparison (more portable than bc)
          if [ "$(awk "BEGIN {print ($PACKAGE_SIZE_NUM > 50)}")" -eq 1 ]; then
            echo "âŒ ERROR: npm package is ${PACKAGE_SIZE} ${PACKAGE_UNIT} (exceeds 50MB limit)"
            echo ""
            echo "Large npm packages cause:"
            echo "  - Slow installs for users"
            echo "  - High npm registry storage costs"
            echo "  - Potential publish failures"
            echo ""
            echo "Review your package.json 'files' array to exclude unnecessary files."
            exit 1
          fi
        fi

        echo "âœ… Package size is acceptable: $PACKAGE_SIZE $PACKAGE_UNIT"

    - name: Check for voice models in npm package
      run: |
        echo "ðŸ” Checking if voice models would be included in npm package..."

        npm pack --dry-run 2>&1 | grep -q "\.onnx" && {
          echo "âŒ ERROR: Voice model files (.onnx) found in npm package!"
          echo ""
          echo "Voice models should NOT be included in npm package."
          echo "They should be downloaded separately during installation."
          echo ""
          echo "Found .onnx files:"
          npm pack --dry-run 2>&1 | grep "\.onnx"
          exit 1
        }

        echo "âœ… No voice models in npm package"

    - name: Summary
      if: success()
      run: |
        echo "âœ… All file size checks passed!"
        echo ""
        echo "Repository: No files > 10MB"
        echo "npm package: Size acceptable, no voice models"
